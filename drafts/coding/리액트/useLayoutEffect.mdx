---
title: "useLayoutEffect 탐구"
date: "2024-03-24"
categories: coding
tags: 리액트
description: hooks
pinned: false
---
<HeadingNavigator />

### 렌더링 프로세스에서

`useEffect`는 UI가 화면에 그려지고 난 뒤 실행되는 훅이다. 그래서 부차 또는 부가효과(side effect)라고도 불린다. 비동기적으로 수행되기 때문에 커밋 단계에 이어지는 일련의 동기 작업 후에 위치한다. 여기서 호출된 `setState`들은 하나의 스케쥴링 큐에 들어가고,  `useEffect`가 끝난 직후 상태 업데이트를 시작한다. 이 과정에서 여러 개의 업데이트를 하나로 엮어 한번의 리렌더링만 요청한다. 브라우저의 Reflow를 효과적으로 줄이기 위한 방편이다.

### useLayoutEffect가 필요한 상황

그러나 이런 특성 탓에 생기는 부작용이 있다. 가령 마운트 되자마자 상태 업데이트를 하여 그 값을 UI에 나타내고자 할 때다. 최초 페인팅이 최초의 useEffect보다 먼저 일어나기 때문에, 개발자가 의도했던 첫화면이 한번의 깜빡임을 거쳐 표현될 수가 있다. 이건 불쾌하다.

`useLayoutEffect` 쓸모가 여기서 생겨난다. 이 훅은 커밋 단계와 리페인팅 사이에 동기적으로 존재하면서 `useEffect`의 단점을 보완한다.  하지만 이는 일반적으로 사용되기보다 가급적 사용될 것이 권장된다[^1]. `useEffect`의 구멍을 메우기 위해 존재하나 최적화 관점에서 어긋나는 훅이기 때문이다. 

물론 그를 통해 소기의 문제는 해결된다. 깜빡임없이 원하는 상태값을 첫화면에 보여줄 수 있다. 하지만 이는 또다른 부작용을 낳을 수 있는데

<br />
<Img src='/images/2023/react/hookflow.webp' />

### 어떤 부작용?

바로 이 훅이 동기적으로 수행되는 탓에 생기는 부작용이다. `useLayoutEffect` 의 연산이 길어지면 길어질수록 화면을 그리는 데 오랜 시간이 소요된다. 최악의 경우 백지 상태를 몇 초간 노출할 수 있다. 빈대 잡으려다 초가삼간 다 태우는 꼴이다.

> <label className="green" />
> 주의할 다른 하나는 `useLayoutEffect`에서 상태값을 업데이트 하고 있을 때, `layoutEffect`가 `effect`를 <q>플러시</q>한다는 것이다. 일반적으로 `effect`는 리페인팅 후에 위치하는데, `layoutEffect`에 의해 리페인팅이 밀리면서 다음 렌더 단계에 동기적으로 진입하는 경우 `effect`를 바로 수행하고 넘어간다.  
> ❌ 레이아웃 이펙트 ➝ 레이아웃 이펙트 ➝  리페인팅 ➝ 이펙트  
> ✅ 레이아웃 이펙트 ➝ 이펙트 ➝ 레이아웃 이펙트 ➝ 리페인팅 ➝ 이펙트


### 결론
`useLayoutEffect`는
1. 돔 요소에 접근해 이를 `state`로 관리하고 
2. 리페인트 전 화면에 보여줄 때 사용된다
3. 하지만 가급적 쓰지 않는 것이 좋다

<br />
<br />

---
#### 참고자료
[^1]: [페이스북 답변](https://github.com/facebook/react/issues/17334)
